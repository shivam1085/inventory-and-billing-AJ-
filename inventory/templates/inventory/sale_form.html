{% extends 'inventory/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Create Sale - Auto Parts Inventory{% endblock %}

{% block content %}
<!-- Quick Add Customer Modal -->
<div class="modal fade" id="quickAddCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quick-customer-form">
                    {% csrf_token %}
                    {{ customer_form|crispy }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Create Sale</h2>
    </div>
    <div class="card-body">
        <form method="post" id="sale-form">
            {% csrf_token %}
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-start gap-2">
                        {{ sale_form|crispy }}
                        <button type="button" class="btn btn-secondary mt-4" data-bs-toggle="modal" data-bs-target="#quickAddCustomerModal">
                            + New Customer
                        </button>
                    </div>
                </div>
            </div>

            <h4 class="mt-4">Products</h4>
            {{ item_formset.management_form }}
            <div class="table-responsive">
                <table class="table" id="items-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th style="width: 150px;">Quantity</th>
                            <th style="width: 100px;">Price</th>
                            <th style="width: 100px;">Total</th>
                            <th style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in item_formset %}
                            <tr class="item-form">
                                <td>
                                    {{ form.product|as_crispy_field }}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </td>
                                <td>
                                    <div class="input-group">
                                        <button type="button" class="btn btn-outline-secondary qty-dec">-</button>
                                        {{ form.quantity|as_crispy_field }}
                                        <button type="button" class="btn btn-outline-secondary qty-inc">+</button>
                                    </div>
                                </td>
                                <td class="price-cell">-</td>
                                <td class="total-cell">-</td>
                                <td>
                                    {% if forloop.first %}
                                        <button type="button" class="btn btn-success btn-sm" id="add-item">+</button>
                                    {% else %}
                                        <button type="button" class="btn btn-danger btn-sm remove-item">×</button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                            <td id="grand-total">₹0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Create Sale</button>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quick Add Customer functionality
    const saveCustomerBtn = document.getElementById('saveCustomerBtn');
    const customerSelect = document.getElementById('id_customer');
    
    saveCustomerBtn.addEventListener('click', function() {
        const form = document.getElementById('quick-customer-form');
        const formData = new FormData(form);
        formData.append('quick_add_customer', 'true');
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url "create_sale" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new customer to select options
                const option = new Option(data.customer_name, data.customer_id);
                customerSelect.add(option);
                customerSelect.value = data.customer_id;
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddCustomerModal'));
                modal.hide();
                
                // Clear form
                form.reset();
                
                // Show success message
                alert('Customer added successfully!');
            } else {
                alert('Please check the form for errors.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding customer. Please try again.');
        });
    });

    // Sale form functionality
    const itemsTable = document.querySelector('#items-table tbody');
    const addButton = document.querySelector('#add-item');
    const totalForms = document.querySelector('#id_items-TOTAL_FORMS');
    const productPrices = {};
    
    // Function to update price and total for a row
    function updateRowCalculations(row) {
        const productSelect = row.querySelector('select[id$="-product"]');
        const quantityInput = row.querySelector('input[id$="-quantity"]');
        const priceCell = row.querySelector('.price-cell');
        const totalCell = row.querySelector('.total-cell');
        
        if (productSelect.value && quantityInput.value) {
            const price = productPrices[productSelect.value] || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            priceCell.textContent = `₹${price.toFixed(2)}`;
            totalCell.textContent = `₹${(price * quantity).toFixed(2)}`;
        } else {
            priceCell.textContent = '-';
            totalCell.textContent = '-';
        }
        updateGrandTotal();
    }
    
    // Function to update grand total
    function updateGrandTotal() {
        const totalCells = document.querySelectorAll('.total-cell');
        let grandTotal = 0;
        totalCells.forEach(cell => {
            const value = cell.textContent.replace('₹', '');
            if (value !== '-') {
                grandTotal += parseFloat(value);
            }
        });
        document.getElementById('grand-total').textContent = `₹${grandTotal.toFixed(2)}`;
    }
    
    // Add new item form
    addButton.addEventListener('click', function() {
        const forms = itemsTable.getElementsByClassName('item-form');
        const formCount = forms.length;
        const row = forms[0].cloneNode(true);
        
        // Update form index
        row.innerHTML = row.innerHTML.replace(/-0-/g, `-${formCount}-`);
        row.innerHTML = row.innerHTML.replace(/_0_/g, `_${formCount}_`);
        
        // Clear values
        row.querySelectorAll('input, select').forEach(el => el.value = '');
        
        // Replace add button with remove button
        const tdLast = row.querySelector('td:last-child');
        tdLast.innerHTML = '<button type="button" class="btn btn-danger btn-sm remove-item">×</button>';
        
        // Reset calculations
        row.querySelector('.price-cell').textContent = '-';
        row.querySelector('.total-cell').textContent = '-';
        
        itemsTable.appendChild(row);
        totalForms.value = formCount + 1;
        
        // Reattach event listeners
        attachRowEventListeners(row);
    });
    
    // Function to handle quantity changes
    function handleQuantityChange(input) {
        const row = input.closest('tr');
        const productSelect = row.querySelector('select[id$="-product"]');
        const value = parseInt(input.value) || 0;
        
        if (value < 1) {
            input.value = 1;
        } else if (productSelect.value) {
            // Get max stock from product option's data attribute
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const maxStock = parseInt(selectedOption.dataset.stock) || 0;
            if (value > maxStock) {
                alert(`Only ${maxStock} units available in stock`);
                input.value = maxStock;
            }
        }
        updateRowCalculations(row);
    }
    
    // Attach event listeners to a row
    function attachRowEventListeners(row) {
        const productSelect = row.querySelector('select[id$="-product"]');
        const quantityInput = row.querySelector('input[id$="-quantity"]');
        const qtyDec = row.querySelector('.qty-dec');
        const qtyInc = row.querySelector('.qty-inc');
        
        productSelect.addEventListener('change', () => {
            // When a product is selected, get its price from the option's data attribute
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // Get price from our API endpoint
                fetch(`/api/products/${selectedOption.value}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.selling_price) {
                            productPrices[selectedOption.value] = parseFloat(data.selling_price);
                            updateRowCalculations(row);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching product price:', error);
                    });
            }
            updateRowCalculations(row);
        });
        
        quantityInput.addEventListener('change', () => handleQuantityChange(quantityInput));
        quantityInput.addEventListener('input', () => handleQuantityChange(quantityInput));
        
        qtyDec.addEventListener('click', () => {
            quantityInput.value = Math.max(1, (parseInt(quantityInput.value) || 1) - 1);
            handleQuantityChange(quantityInput);
        });
        
        qtyInc.addEventListener('click', () => {
            quantityInput.value = (parseInt(quantityInput.value) || 0) + 1;
            handleQuantityChange(quantityInput);
        });
    }
    
    // Remove item form
    itemsTable.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            e.target.closest('tr').remove();
            const forms = itemsTable.getElementsByClassName('item-form');
            totalForms.value = forms.length;
            updateGrandTotal();
        }
    });
    
    // Initialize event listeners for existing rows
    document.querySelectorAll('.item-form').forEach(row => attachRowEventListeners(row));
});
</script>
{% endblock %}